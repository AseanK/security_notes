# Network Traffic and logs

## Overview of logs

**Log** is a record of events that occur within an organization's system

- Record details of what, where, and when an event occured on the system
  - helps not only for troubleshooting issue, but for security monitoring

### Log analysis

The process of examining logs to identify events of interest
- Enourmous volume of log data can be generated
  - Helpful to be selective in what you log, so that you can log efficiently
- SIEM tools help process large log volumes from multiple data sources in real-time
  - Software known as *log forwarders* collect logs from various sources and automatically forward them to a centralized log repository for storage

#### Details

Generally, logs contain
- Date
- Time
- Location
- Action
- Author of the action

#### Types of log

- Network logs
  - Generated by devices such as proxies, routers, switches, and firewalls
- System logs
  - Generated by operating systems
- Application logs
  - Related to software applications
- Security logs
  - Generated by security tools like IDS or IPS
- Authentication logs
  - Record login attempts

#### Common format

- Syslog
  - Protocol
    - The syslog protocol is used to transport logs to a centralized log server for log management
    - port 514 for planintext logs, port 6514 for encrypted logs
  - Service
    - The syslog service acts as a log forwarding service that consolidates logs from multiple sources into a single location
  - Log format
    - One of the most commonly used log formats
    - Native logging format used in Unix systems
    - Consists of three components: *Header*, *Structured-data*, *Message*
      - *Header*
        - Contains details like the timestamp, hostname, application name, and message ID
      - *Structured-data*
        - Contains additional logging information
        - Enclosed in square brackets and structured in key-value pairs
      - *Message*
        - Contains a detailed log message about the event
      - *Priority (PRI)*
        - Indicates the urgency of the logged event
        - The lower the prioirity level, the more urgent the event is
        - Contained with an angle brackets `<236>`
```
<236>1 2022-03-21T01:11:11.003Z virtual.machine.com evntslog - ID01 [user@32473 iut="1" eventSource="Application" eventID="9999"] 
This is a log entry!
```
- JSON (JavaScript Object Notation)
  - File format that is used to store and transmit data
  - Known for its simplicity and easy readability
```JSON
"User"
{ 
  "id": "1234", 
  "name": "user",
  "role": "engineer"
}
```
- XML (Extensible Markup Language)
  - A language and a format used for storing and transmitting data
  - Uses *Tags*, *Elements*, and *Attributes*
    - *Tags*
      - Used to store and identify data
      - Pairs that must contain a start tag and an end tag
      - start = `<tag>` end = `</tag>`
    - *Elements*
      - Iclude both the data contained inside of a tag and the tags itself
      - All XML entries must contain at least one root element
      ```
      <Event>	
        <EventID>4688</EventID>
        <Version>5</Version>
      </Event>
      ```
      - `<Event>` is the root element and contains two child elements `<EventId>` and `<Version>`
    - *Attributes*
      - Used to provide additional information about elements
      - Included as the second part of the tag itself and must always be quoted
      ```
      <EventData>
        <Data Name='SubjectUserSid'>S-2-3-11-160321</Data>
        <Data Name='SubjectUserName'>JSMITH</Data>
      </EventData>
      ```
      - `<Data>` tag uses the attributes `Name='SubjectUserSid'` and `SubjectUserName'`
- CSV (Comma Separated Values)
  - A format uses separators like commas to separate data values
  ```
  2009-11-24T21:27:09.534255,ALERT,192.168.2.7, 1041,x.x.250.50,80,TCP,ALLOWED,1:2001999:9,"ET MALWARE BTGrab.com Spyware Downloading Ads",1
  ```
- CEF (Common Event Format)
  - Log format that uses key-value pairs to structure data and identify fields and their corresponding values
  - Fields are all separated with a pipe symbol `|`
  - Anything in the Extension part of the CEF log entry must be written in a key-value format
  - Syslof is a common method used to transport logs like CEF
  ```
  Sep 29 08:26:10 host CEF:1|Security|threatmanager|1.0|100|worm successfully stopped|10|src=10.0.0.2 dst=2.1.2.2 spt=1232
  ```

## Overview of IDS

IDS (Intrusuib detection system) is an application that monitors activity and alerts on possible intrusions\
Detection requires data, and this data can come from various data sources

#### Telemetry

- Collection and transmission of data for analysis
- While logs record events occuring on systems, telemetry describes the data itself

### HIDS (Host-based itrusion detection system)

- An application that monitors the activity of the host on which it's installed
- Typically, HIDS agents are installed on all endpoints and used to monitor and detect security threats
- Monitors internal activity happening on the host to identify any unauthoirized or abnormal behavior
- Used to monitor inbound and outbound trffic flows, file systems, system resource usage, user activity, and more

![img](https://d3c33hcgiwev3.cloudfront.net/imageAssetProxy.v1/r9hBQHsQSv-hult8KB1V8g_17a68a6257c143738588e048ca8d26f1_FhxPKoFNfXgXc6ReM_Srb2o974QJ0U-ULsPViUoB-bhM_iCgEJA4kCxBBaXg8V_I8OgPIpF5g77EffByf9aub_pTG33UzSLum4eyKCK7YZPXGvZjqG1jLW-bJ4yozWlzoOSJ7i99ZiyAfKfNBe0DyFMKE3UyQv--RRTEACIegsbPdyqlv4gHQAGRdIyMMQ?expiry=1700265600000&hmac=6jSW4yqlLiRGOyLhk-XrbGV9gV-IQ2RdcLBLSvosEg4)

### NIDS (Network-based intrusion detection system)

- An application that collects and monitors network traffic and network data
- NIDS software is installed on devices located at specific parts of the network that you want to monitor
- Inspects network traffic from different devices on the network

![img](https://d3c33hcgiwev3.cloudfront.net/imageAssetProxy.v1/m2NQ9waXQzm_kmnrpieaAQ_081c3ddbccb64cf8aa0ad09806fdf8f1_CS_R-137_NIDS.png?expiry=1700265600000&hmac=hlRVUPsJwqQlqNLs-HcffnKwYlAAFrc0-6tBzKBMAiU)

Using a combination of HIDS and NIDS to monitor an envirnment can provide a multi-layered approach to intrusion detection and response

#### Components of a NIDS rule

1. Action
  - Typicallym the first item specified in a signature
  - determines the action to take if the rule criteria matches are met
  - Actions differ acress NIDS rule languages, but some common actions are
    - alert, pass, or reject
2. Header
  - Defines the signature's network traffic
    - Include information such as source and destination IP addresses/ports, protocols, and traffic direction
3. Rule options
  - lets you customize signatures with additional parameters
  - Configuring rule options help in narrowing down network traffic


#### Detection techniques

- Detection systems can use different techniques to detect threats and attacks
- Common types of detection techniques uesd by IDS
  - **Signiture-based analysis**
    - A detection method that is used to find events of interest
    - *Signature* is a pattern that is associated with malicious activity
      - Can contain specific patterns like a sequence of binary numbers, bytes, or even specific data like IP address
    - Advantages
      - Low rate of false positive
    - Disadvantages
      - Signatures can be evaded
      - Signatures require updates
      - Inability to detect unknown threats
  - **Anomaly-based analysis**
    - A detection method that identifies abnormal behavior
    - Two phases
      - Training phase
        - A baseline of normal or expected behavior is established
        - Baselines are developed by collecting data that corresponds to normal system behavior
      - Detection phase
        - The current system activity is compared against the baseline
    - Advantages
      - Ability to detect new and evolving threats
    - Disadvantages
      - High rate of false positive
      - Pre-existing compromise will be included in the baseline

### Suricata

An open-source IDS, IPS and network analysis tool

#### Rules

Used to identiify specific patterns, behavior, and conditions of network traffic that might indicate malicious activity
- Suricata uses **signature alalysis**
![img](https://d3c33hcgiwev3.cloudfront.net/imageAssetProxy.v1/sUAYMHVdQ-2IJCnBysJmzg_c3deef0b2a6c454fbc39b674cc0bc9f1_CS_R-138_Suricata-signature.png?expiry=1700265600000&hmac=uJ6REEYk6pBBSHWR1YHmuAOH6h9TfmlA84uDDNukRdw)

- Although Suricata comes with pre-written rules, it is highly recommended that you modify or customize the existing rules to meet your specific security requirements

#### Configuration file

A file used to configure the settings of an application
- lets you customize exaxtly how you want your IDS to interact with the rest of your environment
- Suricata's configuration file is `suricata.yaml`

#### Log files

There are two log files that Suricata generates
- `eve.json`
  - Standard Suricata log file
  - Contains detailed information and metadata about the events and alerts generated by Suricata stored in JSON format
- `fast.log`
  - Used to record minimal alert information including basic IP address and port details about the network traffic
  - Basic logging and alerting and considered a legacy file format
  - **Not suitable for incident response or threat hunting tasks**

## Overview of SIEM tools

SIEM is an application that collects and alnalyzed log data to monitor critical activities in an organization

### Process

1. Collect and aggregate data
2. Normalize data
3. Analyze data

#### Splunk

- Data analysis platform
- Provides SIEM solutions that let you search, analyze, and visualize security data
- It first collects data from different sources
- Data gets processed and stored in an index
  - Can be accessed in a variety of different ways, like through search

**SPL** (Search Processing Language) is Splunk's query language
- Example: `index=main fail | chart count by host`
  - `index=main`: command that tells Splunk to retrieve events from an `index` named `main`
  - `fail`: tells Splunk to return any event that contains the term `fail`
  - `|`: the pipe character separates and chains the two commands
    - The output of the first command `index=main` is used as input of the second command `chart count by host`
  - Wildcard `*` is a special character that can be substituted with any other character

![img](https://d3c33hcgiwev3.cloudfront.net/imageAssetProxy.v1/zmjvpMvASVuLzBl6p1-KJg_48cf882e1ea14f6ca2f3ceee91e1f2e1_cIW5xo7oKZMktF78z_u5eTeEJANj9wPgAG39QVCd8PDuvdrztqt2N1fJMbJOFms1QoIgAk0YNgHWjR1LQMLg__bhWqMMWmWke6kQmoWLpyxM5eVwNDyW7_2KttYjVSz2fYPCX4arj1TUHKrSfANwCU8?expiry=1700352000000&hmac=gZZsvzAM__cVxBSPNdYBqzyrefN3Ekjt_jg7Si1MC2g)

#### Chronicle

- Google Cloud's SIEM
- Stores security data for search, analysis, and visualization
- Data first gets forwarded to Chronicle
- Data then gets normalized, or cleaned up, so it's easier to process and index
- Data becomes availalbe to be accessed through a search bar

Chronicle uses **YARA-L** language to define rules for detection
- *YARA-L*: A computer language used to create rules for searching through ingested log data
- Types of search
  - UDM search (Unified Data Model)
    - Searches through normalized data
    - All UDM events contain a set of common fields including
      - Entities
        - AKA nouns
        - All UDM events must contain at least one entitiy
        - Provides additional context about a device, user, or process that's involved in an event
      - Event metadata
        - Provides a basic description of an event
      - Network metadata
        - Provides information about network-related events and protocol details
      - Security results
        - Provides the security-related outcome of events
    - Example: `metadata.event_type = "USER_LOGIN"`
      - `metadata.event_type` contains information about the event type
      - `USER_LOGIN` searches for events relating to authentication

      ![img](https://d3c33hcgiwev3.cloudfront.net/imageAssetProxy.v1/JzVkQ2HKR9GWPXAVp86RDA_fd86cffb80f149308081b1743f8fc2e1_4h28Y1oIHmI1Ot2LJQBbPIZXGBM3pa5uf5XhEmIBT1gpQ6VoU64Iz0MmaDiIheqMmXzNw6ROML3r7HAMB38OwaOur8PgwJO8dLvVVWC8t7IkM63S0wkJIRvnueiI2BN1nfUtfIXgn7UG7VoW5BhLkaQ?expiry=1700352000000&hmac=3fGjOawztlwIvfm_syYeGZheX8_UJd_-BEsJ7POqcRM)

  - Raw log search
    - Searches through the logs which have not been normalized
